<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head><body>
  <script src="./countries.js"></script>
  <script>
    const isNotProvince = ({Province}) => Province === ''

    const getDateOfFirstConfirmedCase = dataPoints => (
      new Date(dataPoints[0].Date)
    )

    const getDailyDeaths = dataPoints => (
      dataPoints
        .map((dataPoint, dataPointIndex, dataPoints) => {
          const deathsToday = dataPoint.Deaths
          if (dataPointIndex === 0) {
            return deathsToday
          }
          const deathsYesterday = dataPoints[dataPointIndex - 1].Deaths
          // Ignore decreasing total deaths
          const correctedDeathsToday = (
            (deathsYesterday > deathsToday)
              ? deathsYesterday
              : deathsToday
          )
          return (correctedDeathsToday - deathsYesterday)
        })
    )

    const getMovingWeeklyAverageOfDailyDeaths = dataPoints => (
      getDailyDeaths(dataPoints)
        .map((dataPoint, dataPointIndex, dataPoints) => {
          return (
            (dataPoint
              + (dataPoints[dataPointIndex - 1] || 0)
              + (dataPoints[dataPointIndex - 2] || 0)
              + (dataPoints[dataPointIndex - 3] || 0)
              + (dataPoints[dataPointIndex - 4] || 0)
              + (dataPoints[dataPointIndex - 5] || 0)
              + (dataPoints[dataPointIndex - 6] || 0)
            ) / 7
          )
        })
    )

    const getCountryData = async ({slug, population}) => {
      const response = await fetch(`https://api.covid19api.com/dayone/country/${slug}`)
      const dataPoints = await response.json()
      const relevantDataPoints = dataPoints.filter(isNotProvince)
      const dateOfFirstConfirmedCase = getDateOfFirstConfirmedCase(relevantDataPoints)
      const movingWeeklyAverageOfDailyDeaths = getMovingWeeklyAverageOfDailyDeaths(relevantDataPoints)
      const movingWeeklyAverageOfDailyDeathsPerMillion = movingWeeklyAverageOfDailyDeaths.map(
        deaths => deaths * 1000000 / population
      )
      return movingWeeklyAverageOfDailyDeathsPerMillion
    }

    const init = async () => {
      const data = await getCountryData({
        slug: 'denmark',
        population: 5792202
      })
      console.log(data)
    }

    init()
  </script>
</body></html>