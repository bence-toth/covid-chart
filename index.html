<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./styles.css" />
  <title>Document</title>
</head><body>
  <aside></aside>
  <main>
    <h1>Header will come here</h1>
    <div id='chart'>Chart will come here</div>
  </main>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="./countries.js"></script>
  <script src="./consumer.js"></script>
  <script src="./init.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {
      packages: ['corechart']
    })
    google.charts.setOnLoadCallback(init)

    const drawChart = ({data, selectedCountries}) => {
      const displayedCountries = selectedCountries.map(country => ({
        slug: country,
        name: countries.find(({slug}) => slug === country).name,
        data: data[country].movingWeeklyAverageOfDailyDeathsPerMillion,
        startDate: data[country].dateOfFirstConfirmedCase,
        endDate: data[country].dateOfLastConfirmedCase
      }))

      const longestDatasetLength = Math.max(
        ...(displayedCountries.map(
          ({data}) => data.length
        ))
      )

      const earliestStartDate = Math.min(
        ...(displayedCountries.map(
          ({startDate}) => startDate.getTime()
        ))
      )

      displayedCountries.forEach(country => {
        if (country.data.length < longestDatasetLength) {
          country.data.unshift(...(new Array(longestDatasetLength - country.data.length).fill(0)))
        }
      })

      const chartData = google.visualization.arrayToDataTable([
        [
          'Date',
          ...displayedCountries.map(({name}) => name)
        ],
        ...(new Array(longestDatasetLength).fill(null).map((_, dataPointIndex) => [
          new Date(earliestStartDate + (dataPointIndex * 1000 * 60 * 60 * 24)),
          ...displayedCountries.map(({data}) => data[dataPointIndex])
        ]))
      ])

      const options = {
        legend: {
          position: 'bottom'
        },
        chartArea: {
          width: document.getElementById('chart').clientWidth - 90,
          height: document.getElementById('chart').clientHeight - 150,
          top: 30,
          right: 0
        }
      }

      const chart = new google.visualization.LineChart(document.getElementById('chart'))

      chart.draw(chartData, options)
    }
  </script>
</body></html>
